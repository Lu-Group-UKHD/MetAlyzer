---
title: "MetAlyzer User Guide"
author: "Nils Mechtel & Carolin Andresen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
Vignette: >
  %\VignetteIndexEntry{Read and Analyze MetIDQ&trade; Software Output Files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignettePackage{MetAlyzer}
---

```{r, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo=TRUE, collapse=T, comment='#>')
library(MetAlyzer)
library(ggplot2)
library(dplyr)
```

The package provides methods to read output files from the MetIDQ™ software into R. Metabolomics data is read and reformatted into an S4 object for convenient data handling, statistics and downstream analysis.

## Install

There is a version available on CRAN.
``` {r}
install.packages("MetAlyzer")
```

But for the latest Version you can also install directly from the github repository.
``` {r}
library(devtools)
install_github("nilsmechtel/MetAlyzer")
```

## Overview

![](%60r%20rprojroot::is_r_package$find_file('vignettes/MetAlyzer_workflow.png')%60){width="100%"}

The package takes metabolomic measurements as ".xlsx" files generated from the MetIDQ™ software. Additionally, meta data for each sample can be provided for further analysis.

Effective quantification of metabolites requires a reliable signal. The limit of detection (LOD) is defined as 3 times signal-to-noise of the baseline, calculated by the software MetIDQ for each metabolite. Values are classified as "Valid", "LOQ" (below limit of quantification) or "LOD" (below limit of detection). This information is encoded in the color in the ".xlsx" table. Further color codes can include "ISTD Out of Range", "Invalid" and "Incomplete". The MetAlyzer packages allow to read both information, the value and the quantification status, gives statistics about the quantification efficacy and allows filtering based on the LOD.

![Example of excel sheet.](%60r%20rprojroot::is_r_package$find_file('vignettes/screenshot_xlsx.png')%60){width="100%"}

## Get started

To present the functionalities of the package, we use a data set published by [Gegner <i>et al</i>. 2022](https://doi.org/10.1101/2021.12.16.472947). This data set used 6 (1 to 6) different extraction methods to quantify 630 metabolites in triplicates for 4 tissue types (Drosophila, Mouse Liver, Mouse Kidney, Zebrafish Liver). It is also included in the MetAlyzer Package and can be accessed via:
Set data paths to the example data and a meta data file:

```{r set_data_path}
fpath <- system.file("extdata", "extraction_data.xlsx", package = "MetAlyzer") 
test_xl <- system.file("extdata", "MetIDQ_XL.xlsx", package = "MetAlyzer") 

mpath <- system.file("extdata", "example_meta_data.rds", package = "MetAlyzer") 
```

Now we load the data into R using the function *MetAlyzer_dataset* and store it in an MetAlyzer object:

```{r initialize}
MetAlyzer_proj <- MetAlyzer_dataset(file_path = fpath)
```

This generates a SummarizedExperiment (SE) using data extracted from the Excel sheet. The SE includes assay information with concentration values and quantification status, while the row Data section contains metabolites and their respective classes. It is important to note that there are 630 metabolites, and 232 metabolite indicators calculated using the MetIDQ™ software. The column Data contains the provided metadata. Furthermore, the SE's metadata section stores the file path, sheet number, status list, and aggregated data for downstream visualizations.

The various elements within the SummarizedExperiment (SE) can be accessed in a manner consistent with a typical SE.

**For example:**

```{r getter}
meta_data <- SummarizedExperiment::colData(MetAlyzer_proj)
head(meta_data)
```

```{r getter}
metabolites <- SummarizedExperiment::rowData(MetAlyzer_proj)
head(metabolites)
```

```{r getter}
quantification_status <- SummarizedExperiment::assays(MetAlyzer_proj)$quant_status
head(quantification_status, c(5, 5))
```

```{r getter}
concentration_values <- SummarizedExperiment::assays(MetAlyzer_proj)$conc_values
head(concentration_values, c(5, 5))
```

### Show statistics

The function *summarizeQuantData* gives an overview of the quantification status of the metabolites. E.g 34.16% of metabolites where below the Limit of Detection.

```{r summarizeQuantData}
summarizeQuantData(MetAlyzer_proj)
```

 The function *summarizeConcValues* prints the quantiles and the amount / percentage of NAs in the concentration data.

```{r summarizeConcValues}
summarizeConcValues(MetAlyzer_proj)
```

### Manage metabolites and meta data

To subset the data set, the functions *filterMetabolites* and *filterMetaData* can be used to filter for certain metabolites / classes or meta data. The original data is not kept, so to reset the filtering the Summarized Experiment has to be reinitialized.

**For example, we want to exclude the metabolite indicators:**

```{r filter_metabolites}
MetAlyzer_proj <- filterMetabolites(MetAlyzer_proj, "Metabolism Indicators")
```

**There are also 2 blank samples in the data that we want to remove:** The extraction methods are encoded in the column "Sample Description" of the meta data. We only keep those samples that are named c(1:6).

```{r filter_meta_data}
MetAlyzer_proj <- filterMetaData(MetAlyzer_proj, `Sample Description` %in% 1:6)
```


**The meta data column names can be changed after creating the Summarized Experiment:** For example, we want to rename the column "Sample Description" to "Method".

```{r updateMetaData}
MetAlyzer_proj <- renameMetaData(MetAlyzer_proj, Method = 'Sample Description')
```

**Additional meta data can be added after creating the Summarized Experiment:** For example, we want to add the column "Date" with the current date to the meta data.

```{r updateMetaData}
MetAlyzer_proj <- updateMetaData(MetAlyzer_proj, Date = Sys.Date(), Analyzed = TRUE)
```
**<--! #THIS DOES ONLY WORK WITH EXAMPLE DATA INCLUDED -->**
We can also add meta data from a excel file. For example, we want to add the colum **$dont know$** from the excel file **$mpath$** to the meta data.

```{r updateMetaData}
additional_meta_data <- read.xlsx(mpath)
head(additional_meta_data)
MetAlyzer_proj <- updateMetaData(MetAlyzer_proj, name = Replicate,
                                 new_colum = additional_meta_data$Replicate)
```

```{r getter}
meta_data <- SummarizedExperiment::colData(MetAlyzer_proj)
head(meta_data)
```

### Analysis and Visuals

The Summarized Experiment generated, also contains a tibble data frame with the aggregated data. This data frame is used for further analysis and visualizations.

In case NAs or zeros are produced, we provide zero imputation as described in ([Gegner <i>et al</i>.](https://doi.org/10.1101/2021.12.16.472947)). To impute the NAs we can set the argument *impute_NA* to TRUE. The argument *perc_of_min* specifies the percentage of the minimum concentration value that is used for imputation. The default is 0.2. 
Imputed concentrations are log2 transformed with the function *transform_data* and can be found in the column "log2_Conc".

```{r imputation}
MetAlyzer_proj <- impute_data(MetAlyzer_proj, perc_of_min = 0.2, impute_NA = TRUE)
MetAlyzer_proj <- transform_data(MetAlyzer_proj)

cat("Number of zero values before imputation:",
    sum(metadata(MetAlyzer_proj)$aggregated_data$Concentration == 0, na.rm = TRUE), "\n")

cat("Number of zero values after imputation:",
    sum(metadata(MetAlyzer_proj)$aggregated_data$imputed_Conc == 0, na.rm = TRUE), "\n")
```

This is just for visualisation, the imputation and transformation is also included into the function *calculate_log2FC*.

Next we can calculate the log2 Fold Change between the extraction methods for each metabolite. As the are 6 extraction methods, the function only calculates for the first 2 Methods. We can use the perviously mentioned function *filterMetaData* to specify the groups.

```{r calculate_log2FC}
MetAlyzer_proj <- filterMetaData(MetAlyzer_proj, Method %in% 3:6)
log2FC_df <- calculate_log2FC(MetAlyzer_proj, Method, impute_perc_of_min = 0.2, impute_NA = TRUE)
```

Here we can see the functions calculates between the third and fourth method after filtering out the first and second method and dropping the methods 5 & 6.

This can be visualized with a volcano plot:

```{r plot_log2FCt, fig.width=7, fig.height=4.5}
p_vulcano <- plot_log2FC(log2FC_df, hide_labels_for = rownames(rowData(MetAlyzer_proj)), vulcano=TRUE)
p_vulcano
```

Or in a scatter plot:
  
```{r plot_log2FC, fig.width=7, fig.height=4.5}
p_fc <- plot_log2FC(log2FC_df, hide_labels_for = rownames(rowData(MetAlyzer_proj)), vulcano=FALSE)
p_fc
```

We also provide the log fold change in the different pathways, to better visualize what group of metabolites shows an increase or decrease in concentration between the 2 extraction Methods.

```{r plot_network, fig.width=7, fig.height=4.5}
network <- plot_network(log2FC_df)
network
```

Incase you want to analyze a dataset from the MxP®Quant 500 XL kit, nothing changes regarding the use of the package. The only difference is the visualized output as there are more metabolites included with this kit.

```{r}
Metalyzer_big_data <- MetAlyzer_dataset(file_path = test_xl)
Metalyzer_big_data <- renameMetaData(Metalyzer_big_data, Method = 'Sample Description')

log2FC_df_big <- calculate_log2FC(Metalyzer_big_data, Method, perc_of_min = 0.2, impute_NA = TRUE)
```
These visualisations will look like this:
```{r plot_log2FCt, fig.width=7, fig.height=4.5}
p_vulcano_big <- plot_log2FC(log2FC_df_big, hide_labels_for = rownames(rowData(MetAlyzer_proj)), vulcano=TRUE)
p_vulcano_big
```
```{r plot_log2FC, fig.width=7, fig.height=4.5}
p_fc_big <- plot_log2FC(log2FC_df_big, hide_labels_for = rownames(rowData(MetAlyzer_proj)), vulcano=FALSE)
p_fc_big
```

## THIS WILL BE PATCHED IN SOON
```{r plot_network, fig.width=7, fig.height=4.5}
network_big <- plot_network(log2FC_df_big)
network_big
```

