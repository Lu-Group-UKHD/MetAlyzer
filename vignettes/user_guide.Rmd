---
title: "User Guide"
author:
  - name: Luis Herfurth
    affiliation:
    - Heidelberg University
output:
  html_document:
    self_contained: true
    toc: true
    toc_float: true
    toc_depth: 5
    code_folding: show
vignette: >
  %\VignetteIndexEntry{User Guide}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: bibliography.bib
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=TRUE, cache=FALSE, collapse=TRUE, comment='#>', warning=FALSE, message=FALSE)

#If you haven't done this yet, install the MetAlyzer package
#devtools::install_github("nilsmechtel/MetAlyzer")
library(dplyr)
```


::: {style="text-align: justify"}
The MetAlyzer R-package provides a robust toolkit for importing, handling, and analyzing metabolomics data generated 
using either the Biocrates Quant500L™ or Quant500XL™ kit and the Biocrates MetIDQ™ software. It structures the data into a 
SummarizedExperiment (SE) object, facilitating integration with Bioconductor workflows and enabling downstream statistical 
analysis and visualization. To aid in biological interpretation, MetAlyzer offers functions to generate key visualizations. 
These include scatter plots, volcano plots to efficiently identify, and particularly a network plot. 
These network visualizations are crucial for understanding the complex interconnections between metabolites, 
helping to find pathway-level alterations and providing a systems perspective on the metabolic response under investigation.
:::

# Loading and Exploring Data
::: {style="text-align: justify"}
MetAlyzer's primary entry point is the read_metidq function, which reads MetIDQ™ .xlsx output files. 
As the output files contain layered information, inform of concentration values and color-coded quantification status (e.g., "Valid", "LOD", "LOQ"), 
it is a tedious task to reliably process this data computationally, as the mix of numerical values and status codes hinders direct machine readability by standard analysis tools.
To conveniently read the data in we provide the function read_metidq(), structuring the data into a SummarizedExperiment (SE) object for easy downstream analysis.
For further demonstration we'll use an example dataset derived from [@Gegner2022], featuring metabolite measurements across different extraction methods 
and tissue types (MxP®Quant 500 kit). This dataset is included in the package.
:::


```{r echo=FALSE, fig.cap="Figure 1: Output of Biocrates MetIDQ™.", out.width="70%", fig.align="center"}
knitr::include_graphics("images/biocrates_output.png")
```


```{r initialise, message=FALSE, warning=FALSE}
# Access the example data file path
fpath <- MetAlyzer::load_rawdata_extraction()

# Load the data into a SummarizedExperiment object
metalyzer_se <- MetAlyzer::read_metidq(file_path = fpath)

# Display the object summary
metalyzer_se
```

::: {style="text-align: justify"}
The resulting SummarizedExperiment object organizes the data:

**Assay**: Contains matrices for conc_values (metabolite concentrations) and quant_status (quantification status). <br>
**rowData**: Stores metabolite information, including names and assigned classes. Note the distinction between quantified metabolites and calculated 'Metabolism Indicators'. <br>
**colData**: Holds sample-specific metadata provided in the input file or added later. <br>
**metadata**: Contains supplementary information like the original file path, sheet index, status color mappings, 
and a pre-joined aggregated_data tibble combining concentrations, status, and metadata for easier analysis and plotting.
:::

```{r showcase, echo=FALSE, warning=FALSE, message=FALSE}
head(SummarizedExperiment::assay(metalyzer_se)) %>%
  kableExtra::kbl(caption = "Preview of Assay containing concentration values.") %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria", font_size = 12)

head(SummarizedExperiment::rowData(metalyzer_se)) %>%
  kableExtra::kbl(caption = "Preview of Assay containing rowData.") %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria", font_size = 12)

head(SummarizedExperiment::colData(metalyzer_se)) %>%
  kableExtra::kbl(caption = "Preview of Assay containing colData.") %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria", font_size = 12)
```



# Visualizing Log2 Fold Changes
::: {style="text-align: justify"}
For the calculation of the Log2FC DataFrame we used the MetaProViz package. (Link to package) (citation)
We'll use the example differential results included in the package (load_diffres()). 
The plotting functions plot_log2FC and plot_network can accept a standard data frame containing log2FC results, provided it has the necessary columns.
This example data was generated from the raw extraction data, also provided in the pakage, it compares the concentrations between different tissue types.
:::

```{r diffres, echo=FALSE, message=FALSE, warning=FALSE}
# code for diffres generation
```


```{r import, message=FALSE, warning=FALSE}
diffres_df <- readRDS(MetAlyzer::load_diffres())

head(diffres_df) %>%
  kableExtra::kbl(caption = "Preview of Assay containing colData.") %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria", font_size = 12)
```

::: {style="text-align: justify"}
This data frame contains columns for metabolite names (Metabolite), their class (Class), calculated log2 fold change (log2FC), and adjusted p-values (adj.P.Val). 
We can directly pass this data frame to the visualization functions.
You can provide a additional colums with numerical values, that can be passed into the visualizations and e plotted.
:::

::: {style="text-align: justify"}
## Scatter Plot

::: {style="text-align: justify"}
The `plot_scatter` function visualizes log2 fold changes, primarily to assess the behavior of different **metabolite classes**. 
Background colors distinguish these classes, enabling users to interpret if certain groups of metabolites exhibit distinct regulatory patterns 
(e.g., consistent up/down-regulation, specific ranges of fold changes). The plot is horizontally separated by extraction method ("LC" left, "FIA" right), 
allowing comparison of whether these observed class-specific trends are consistent across both methods or show method-dependent variations.
:::

```{r scatter, message=FALSE, warning=FALSE, out.width="100%"}
# Scatter plot grouped by metabolic class
MetAlyzer::plot_scatter(diffres_df)
```

## Pathway Network Visualization

::: {style="text-align: justify"}
Visualize significant changes across metabolic pathways using `plot_network`. This function maps the calculated log2 fold changes (log2FC) of metabolites onto a predefined network structure, representing known biochemical reactions and relationships.

### Relevance and Interpretation:

This network visualization provides a **systems-level perspective**, going beyond individual metabolite changes. Its relevance lies in helping users understand how metabolic perturbations are interconnected within the broader context of biological pathways. By examining the network, users can:

* **Identify affected pathways:** Observe clusters of connected nodes with significant changes (indicated by color) within labeled pathways (e.g., "TCA Cycle", "Fatty Acids", "Bile Acids" as seen in Figure X). This suggests potential up- or down-regulation of entire metabolic processes.
* **Understand relationships:** Trace connections between metabolites to see how changes in one area might influence others upstream or downstream.
* **Generate hypotheses:** Patterns observed in the network can suggest underlying mechanisms or key regulatory points affected by the experimental conditions.

:::

```{r network, message=FALSE, warning=FALSE}
# Generate network plot from the data frame
# Requires metabolite, class, log2fc, and p-value columns
network <- MetAlyzer::plot_network(
  diffres_df,
  q_value = 0.05,
  metabolite_col = "Metabolite",
  values_col_name = "log2FC",
  stat_col_name = "qval",
  metabolite_text_size = 2,
  connection_width = 0.75,
  pathway_text_size = 4,
  pathway_width = 4,
)

network$Plot
```

::: {style="text-align: justify"}
### Node Summarization and Representation:

Each node in the network represents a metabolite or a metabolite class. The color of the node typically reflects its log2FC value (incase the viridis scale was selected, yellow represents a positiv log2 Fold Change and purlbe a negative log2 Fold Change).

Some nodes, such as 'T14' which might group related species like 'T 14:0_32:2', 'T 14:0_34:0', 'T 14:0_34:1', display a **summarized value**. This value is calculated according to the following hierarchy to prioritize significant findings:

1.  **Mean of Significant:** If one or more metabolites mapping to the node are statistically significant (e.g., based on FDR corrected p-values), the node's value represents the **mean log2FC of only those significant metabolites**.
2.  **Mean of Measured:** If *none* of the associated metabolites are significant, but measurements exist for them, the node's value represents the **mean log2FC of *all* measured metabolites** mapping to that node.
3.  **NA:** If no metabolites mapping to the node were measured or included in the dataset, the node value is NA (often represented as grey or uncolored, like some nodes in Figure X).

This summarization approach provides a concise overview within the network, highlighting significant changes where present, while still providing context from measured data if significance is not reached.
Due to the changing naming convention of Biocrates, we include old names in the excel file, which will show up as NA for later generated MetIDQ™ outputs (e.g. TG(14:0_32.2)), but this enables the analysis of older files as well.
:::

```{r networkTable, echo=FALSE, message=FALSE, warning=FALSE}
nodes_list <- network$Table
T14_node <- nodes_list[which(nodes_list$Label == "T14"), ]

T14_node_expanded <- tidyr::separate_rows(T14_node,
                                          Metabolites, log2FC, qval, pval,
                                          sep = "\\s*;\\s*") %>%
                     tibble::column_to_rownames("Metabolites") %>%
                     dplyr::rename(p.adj = qval,
                                   `p-value` = pval,
                                   Log2FC = log2FC) %>%
                    dplyr::mutate(Log2FC = as.numeric(Log2FC),
                                  p.adj = as.numeric(p.adj),
                                  `p-value` = as.numeric(`p-value`))
  
T14_node_expanded %>%
  kableExtra::kbl(caption = "T14 Node detailed Information") %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria", font_size = 12)
```

:::
For easy Visualisation of the summarized nodes, you can use the MetaProViz Vulcano Plot (package) (bib).
:::

```{r vulcano, echo=FALSE, message=FALSE, warning=FALSE}
MetaProViz::VizVolcano(InputData = T14_node_expanded, yCutoff = 0.05)
```


# Session information
```{r session_info, echo=FALSE}
options(width = 120)
sessionInfo()
```

# Bibliography
