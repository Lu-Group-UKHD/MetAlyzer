title: "User Guide"
author:
  - name: Luis Herfurth
    affiliation:
    - Heidelberg University
output:
  html_document:
    self_contained: true
    toc: true
    toc_float: true
    toc_depth: 5
    code_folding: show
vignette: >
  %\VignetteIndexEntry{User Guide}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: bibliography.bib
editor_options:
  chunk_output_type: console
---

```
metalyzer_ext_SE <- MetAlyzer_dataset(example_mutation_data_xl())

#Load the data:
data_df <- SummarizedExperiment::assay(metalyzer_ext_SE)

#Get the Metadata
# Access row metadata as a DataFrame
row_metadata_df <- data.frame(SummarizedExperiment::rowData(metalyzer_ext_SE))

# Access column metadata as a DataFrame
col <- SummarizedExperiment::colData(metalyzer_ext_SE)
col_metadata_df <- data.frame(col@listData)
col_metadata_df$RowNames <- col@rownames

#Input MetaProViz
Intra_M <- as.data.frame(t(data_df))#We require that the rownames match the rownames of the SampleInfo

SampleInfo <-col_metadata_df%>%
  column_to_rownames("RowNames")%>%#We require that the rownames match the rownames of the Intra_M
  rename("Sample.Description"="Conditions")#The column Biological_Replicates can also be used during pre-processing (Here I just assumed that these might be the replicates)

MappingInfo <- row_metadata_df

PreprocessingResults <- MetaProViz::PreProcessing(InputData=Intra_M,
                          SettingsFile_Sample = SampleInfo,
                          SettingsInfo = c(Conditions = "Conditions"),
                          FeatureFilt = "Modified",
                          FeatureFilt_Value = 0.8,
                          TIC = TRUE,# As we have raw data we will perform total ion count normalisation
                          MVI = TRUE, #We assume the values are not missing at random and perform half minimum missing value imputation
                          HotellinsConfidence = 0.99,# We perform outlier testing using 0.99 confidence intervall
                          CoRe = FALSE,# as we have a standard experiment and not a Consumption-Release (CoRe) experiment we set this to FALSE
                          SaveAs_Plot = NULL,
                          SaveAs_Table = NULL)

Intra_Preprocessed <- PreprocessingResults[["DF"]][["Preprocessing_output"]]

DMA <- MetaProViz::DMA(InputData=Intra_Preprocessed[,-c(1:12)], #we need to remove columns that do not include metabolite measurements
                              SettingsFile_Sample=SampleInfo,#only maintain the information about condition and replicates
                              SettingsInfo = c(Conditions="Conditions", Numerator="Mutant" , Denominator = "Control"),# we compare all_vs_HK2
                              SettingsFile_Metab = MappingInfo,# Adds metadata for the metabolites such as KEGG_ID, Pathway, retention time,...
                              StatPval ="lmFit",
                              StatPadj="fdr")
DMA_Mutant_vs_Control <- DMA[["DMA"]][["Mutant_vs_Control"]]

DMA_MetAlyzer <- DMA_Mutant_vs_Control %>%
  select(
    Metabolite = Metabolite,
    Class = metabolic_classes,
    log2FC = Log2FC,
    pval = p.val,
    qval = p.adj
  )

network <- MetAlyzer::plot_network(DMA_MetAlyzer, q_value = 0.05)
```