title: "User Guide"
author:
  - name: Luis Herfurth
    affiliation:
    - Heidelberg University
output:
  html_document:
    self_contained: true
    toc: true
    toc_float: true
    toc_depth: 5
    code_folding: show
vignette: >
  %\VignetteIndexEntry{User Guide}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: bibliography.bib
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=TRUE, cache=FALSE, collapse=TRUE, comment='#>', warning=FALSE, message=FALSE)
library(MetAlyzer)
library(SummarizedExperiment)
library(ggplot2)
library(dplyr)
```


::: {style="text-align: justify"}
The MetAlyzer package provides a robust toolkit for importing, handling, and analyzing metabolomics data generated by the MetIDQ™ software. It structures the data into a SummarizedExperiment (SE) object, facilitating integration with Bioconductor workflows and enabling downstream statistical analysis and visualization.
:::

## Core Workflow: Loading and Exploring Data
::: {style="text-align: justify"}
MetAlyzer's primary entry point is the MetAlyzer_dataset function, which reads MetIDQ™ .xlsx output files. 
It intelligently parses concentration values and quantification status (e.g., "Valid", "LOD", "LOQ"), storing them within a SummarizedExperiment object.
For further demonstration we'll use an example dataset derived from Gegner et al. 2022, featuring metabolite measurements across different extraction methods 
and tissue types (MxP®Quant 500 kit). This dataset is included in the package.
:::

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Access the example data file path
fpath <- example_extraction_data()

# Load the data into a SummarizedExperiment object
metalyzer_se <- MetAlyzer_dataset(file_path = fpath)

# Display the object summary
metalyzer_se
```

::: {style="text-align: justify"}
The resulting SummarizedExperiment object organizes the data:

**Assay**: Contains matrices for conc_values (metabolite concentrations) and quant_status (quantification status).
**rowData**: Stores metabolite information, including names and assigned classes. Note the distinction between quantified metabolites and calculated 'Metabolism Indicators'.
**colData**: Holds sample-specific metadata provided in the input file or added later.
**metadata**: Contains supplementary information like the original file path, sheet index, status color mappings, 
and a pre-joined aggregated_data tibble combining concentrations, status, and metadata for easier analysis and plotting.
:::

## Visualizing Pre-Calculated Log2 Fold Changes
::: {style="text-align: justify"}
For the calculation of the Log2FC DataFrame we used the MetaProViz package. (Link to package)
We'll use the example log2 fold change data included in the package (example_log2fc_data()).
The plotting functions plot_log2FC and plot_network can accept a standard data frame containing log2FC results, provided it has the necessary columns.
:::

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
log2fc_df <- example_log2fc_data()
head(log2fc_df)
```

::: {style="text-align: justify"}
This data frame contains columns for metabolite names (Metabolite), their class (Class), calculated log2 fold change (log2FC), and adjusted p-values (adj.P.Val). 
We can directly pass this data frame to the visualization functions. **The Column names are required to match the ones in the example!** 
You can provide an additional colum with numerical values, that can be passed into the visualizations.
:::

### Volcano and Scatter Plots

::: {style="text-align: justify"}
Visualize the log2 fold changes using plot_log2FC. Specify the column names containing the relevant information.
:::

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Scatter plot grouped by metabolic class
plot_vulcano(
  log2fc_df,
  hide_labels_for = log2fc_results$Metabolite, # Hiding all labels
)
```
```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Scatter plot grouped by metabolic class
plot_scatter(
  log2fc_df,
  hide_labels_for = log2fc_results$Metabolite, # Hiding all labels
)
```

### Pathway Network Visualization

::: {style="text-align: justify"}
Visualize significant changes across metabolic pathways using plot_network. 
:::

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Generate network plot from the data frame
# Requires metabolite, class, log2fc, and p-value columns
network <- plot_network(
  log2fc_df,
  metabolite_col = "Metabolite",
  q_value = 0.05,
  metabolite_text_size = 2,
  connection_width = 0.75,
  pathway_text_size = 4,
  pathway_width = 4,
)

network$Plot
network$Table
```

::: {style="text-align: justify"}
This concludes the core overview of MetAlyzer. The package provides a streamlined workflow for importing MetIDQ™ data, performing essential data handling and analysis, and visualizing results, including pre-calculated differential expression data. Consult the function documentation for more detailed options and parameters.
:::