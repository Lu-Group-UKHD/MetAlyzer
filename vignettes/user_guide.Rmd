---
output: html_document
editor_options: 
  chunk_output_type: console
---
title: "User Guide"
author:
  - name: Luis Herfurth
    affiliation:
    - Heidelberg University
output:
  html_document:
    self_contained: true
    toc: true
    toc_float: true
    toc_depth: 5
    code_folding: show
vignette: >
  %\VignetteIndexEntry{User Guide}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: bibliography.bib
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=TRUE, cache=FALSE, collapse=TRUE, comment='#>', warning=FALSE, message=FALSE)

#If you haven't done this yet, install the MetAlyzer package
#devtools::install_github("nilsmechtel/MetAlyzer")
```


::: {style="text-align: justify"}
The MetAlyzer R-package provides a robust toolkit for importing, handling, and analyzing metabolomics data generated 
using either the Biocrates Quant500L™ or Quant500XL™ kit and the Biocrates MetIDQ™ software. It structures the data into a 
SummarizedExperiment (SE) object, facilitating integration with Bioconductor workflows and enabling downstream statistical 
analysis and visualization. To aid in biological interpretation, MetAlyzer offers functions to generate key visualizations. 
These include scatter plots, volcano plots to efficiently identify, and particularly a network plot. 
These network visualizations are crucial for understanding the complex interconnections between metabolites, 
helping to find pathway-level alterations and providing a systems perspective on the metabolic response under investigation.
:::

## Core Workflow: Loading and Exploring Data
::: {style="text-align: justify"}
MetAlyzer's primary entry point is the read_metidq function, which reads MetIDQ™ .xlsx output files. 
As the output files contain layered information, inform of concentration values and color-coded quantification status (e.g., "Valid", "LOD", "LOQ"), 
it is a tedious task to reliably process this data computationally, as the mix of numerical values and status codes hinders direct machine readability by standard analysis tools.
To conveniently read the data in we provide the function read_metidq(), structuring the data into a SummarizedExperiment (SE) object for easy downstream analysis.
For further demonstration we'll use an example dataset derived from Gegner et al. 2022, featuring metabolite measurements across different extraction methods 
and tissue types (MxP®Quant 500 kit). This dataset is included in the package.
:::

@Luis: 
- Add citation using .bib file (e.g. above to cite se paper)

```{{r echo=FALSE, fig.cap="Figure 1: Output of Biocrates MetIDQ™.", out.width="70%", fig.align="center"}}
knitr::include_graphics("images/biocrates_output.png")
```


```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Access the example data file path
fpath <- MetAlyzer::example_extraction_data()

# Load the data into a SummarizedExperiment object
metalyzer_se <- MetAlyzer::read_metidq(file_path = fpath)

# Display the object summary
metalyzer_se
```

::: {style="text-align: justify"}
The resulting SummarizedExperiment object organizes the data:

**Assay**: Contains matrices for conc_values (metabolite concentrations) and quant_status (quantification status).
**rowData**: Stores metabolite information, including names and assigned classes. Note the distinction between quantified metabolites and calculated 'Metabolism Indicators'.
**colData**: Holds sample-specific metadata provided in the input file or added later.
**metadata**: Contains supplementary information like the original file path, sheet index, status color mappings, 
and a pre-joined aggregated_data tibble combining concentrations, status, and metadata for easier analysis and plotting.
:::

```{r, echo=FALSE}
# https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
# Check how our data looks like:
SummarizedExperiment::assay(metalyzer_se) %>%
  kableExtra::kbl(caption = "Preview of Assay containing XXXX.") %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria", font_size = 12)

SummarizedExperiment::rowData(metalyzer_se) %>%
  kableExtra::kbl(caption = "Preview of Assay containing XXXX.") %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria", font_size = 12)

SummarizedExperiment::colData(metalyzer_se) %>%
  kableExtra::kbl(caption = "Preview of Assay containing XXXX.") %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria", font_size = 12)
```


## Visualizing Pre-Calculated Log2 Fold Changes
::: {style="text-align: justify"}
For the calculation of the Log2FC DataFrame we used the MetaProViz package. (Link to package) (citation)
We'll use the example log2 fold change data included in the package (example_log2fc_data()). 
The plotting functions plot_log2FC and plot_network can accept a standard data frame containing log2FC results, provided it has the necessary columns.
:::

@Luis: 
- Please create Differential results, meaning data that include Log2FC and stats. and call the example data something like load_diffres,... maybe above you also want to rather say load_rawdata
showcase how we generated the diffres from the loaded metalyzer_se object, but also load the results as you did. 

- As above showcase the table of the diffres, so the user knows which types of columns they need.
- what are you comparing? explain the example data.
```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
log2fc_df <- example_log2fc_data()
head(log2fc_df)
```

::: {style="text-align: justify"}
This data frame contains columns for metabolite names (Metabolite), their class (Class), calculated log2 fold change (log2FC), and adjusted p-values (adj.P.Val). 
We can directly pass this data frame to the visualization functions. **The Column names are required to match the ones in the example!** 
You can provide an additional colum with numerical values, that can be passed into the visualizations.
:::

### Volcano and Scatter Plots
@Luis: why is it relevant for the user to display the data like this? what can they interpret from this?

::: {style="text-align: justify"}
Visualize the log2 fold changes using plot_log2FC. Specify the column names containing the relevant information.
:::

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Scatter plot grouped by metabolic class
plot_vulcano(
  log2fc_df,
  hide_labels_for = log2fc_results$Metabolite, # Hiding all labels
)
```
```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Scatter plot grouped by metabolic class
plot_scatter(
  log2fc_df,
  hide_labels_for = log2fc_results$Metabolite, # Hiding all labels
)
```

### Pathway Network Visualization
@Luis: why is it relevant for the user to display the data like this? what can they interpret from this?
Also: Explain a bit about the summaries in the plot (we discussed T 14:0). Show the table and discuss it here. Inform the user how to interpret the results. 


::: {style="text-align: justify"}
Visualize significant changes across metabolic pathways using plot_network. 
:::

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Generate network plot from the data frame
# Requires metabolite, class, log2fc, and p-value columns
network <- plot_network(
  log2fc_df,
  metabolite_col = "Metabolite",
  q_value = 0.05,
  metabolite_text_size = 2,
  connection_width = 0.75,
  pathway_text_size = 4,
  pathway_width = 4,
)

network$Plot
network$Table
```

::: {style="text-align: justify"}
This concludes the core overview of MetAlyzer. The package provides a streamlined workflow for importing MetIDQ™ data, performing essential data handling and analysis, and visualizing results, including pre-calculated differential expression data. Consult the function documentation for more detailed options and parameters.
:::

# Session information
```{r session_info, echo=FALSE}
options(width = 120)
sessionInfo()
```

# Bibliography
